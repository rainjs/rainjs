

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>JavaScript and CSS Minification &mdash; Rain v0.33.0 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.33.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Rain v0.33.0 documentation" href="../index.html" />
    <link rel="next" title="NginX static routes server" href="nginx_static_routes.html" />
    <link rel="prev" title="Distributed Websockets" href="distributed_websockets.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="nginx_static_routes.html" title="NginX static routes server"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="distributed_websockets.html" title="Distributed Websockets"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Rain v0.33.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="javascript-and-css-minification">
<h1>JavaScript and CSS Minification<a class="headerlink" href="#javascript-and-css-minification" title="Permalink to this headline">¶</a></h1>
<p>Minification is important to load web applications faster. The scope of this research is to
reduce the page load time by decreasing the number and size of the requests performed by the
browser. The number of requests is decreased by combining multiple CSS or JavaScript files in
a single file. The request size is reduced by removing white spaces and applying other compression
algorithms that gives you smaller files while preserving the same functionality, e.g.: name
mangling, stripping comments etc.</p>
<p>The minification will be performed as a predeployment step using a SDK command like <tt class="docutils literal"><span class="pre">rain</span> <span class="pre">minify</span></tt>
which will generate the minified files for each component. It might be desired that this command
generates a new RAIN project containing only the minified files instead of adding the minified
files in the current project.</p>
<div class="section" id="javascript-minification">
<h2>JavaScript Minification<a class="headerlink" href="#javascript-minification" title="Permalink to this headline">¶</a></h2>
<p>The tool used for JavaScript minification is
<a class="reference external" href="http://requirejs.org/docs/optimization.html">RequireJS Optimizer</a>. It is able to trace
module dependencies and combine multiple RequireJs modules into a single file. When combining
multiple modules in the same file each module must have the optional module name specified:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">define</span><span class="p">(</span><span class="s2">&quot;example/3.0/js/notes&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;js/note&quot;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Note</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">Notes</span> <span class="p">()</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="nx">Notes</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>When performing minification, the client-side controllers associated with each view are identified
and added to the list of modules to be included in the minified file. The dependencies of each
client-side controller are identified and included by the RequireJS Optimizer. This process
generates a file named <tt class="docutils literal"><span class="pre">index.min.js</span></tt> for each component. Any external dependencies are
excluded since it would be redundant to have the same module in multiple files. A sample
configuration used to minify the javascript files for the <tt class="docutils literal"><span class="pre">example</span></tt> component looks like this:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * Path used to locate the modules.</span>
<span class="cm">     * The module path is composed as baseUrl/{moduleName}.js</span>
<span class="cm">     */</span>
    <span class="nx">baseUrl</span><span class="o">:</span> <span class="s1">&#39;/path/to/rain/components/example/client&#39;</span><span class="p">,</span>

    <span class="cm">/*</span>
<span class="cm">     * minification options</span>
<span class="cm">     * Name mangling is disabled since it will also change the names for t, nt and logger.</span>
<span class="cm">     */</span>
    <span class="nx">optimize</span><span class="o">:</span> <span class="s2">&quot;uglify2&quot;</span><span class="p">,</span>
    <span class="nx">uglify2</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">mangle</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">},</span>

    <span class="s2">&quot;packages&quot;</span><span class="o">:</span> <span class="p">[{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;raintime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;raintime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;location&quot;</span><span class="o">:</span> <span class="s2">&quot;../../core/client/js&quot;</span>
    <span class="p">}],</span>

    <span class="cm">/*</span>
<span class="cm">     * The modules to be included in the minified file.</span>
<span class="cm">     * Dependencies are detected automatically by RequireJS Optimizer.</span>
<span class="cm">     */</span>
    <span class="nx">include</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;js/index&#39;</span><span class="p">,</span> <span class="s1">&#39;js/notes&#39;</span><span class="p">,</span> <span class="s1">&#39;js/text_localization&#39;</span><span class="p">],</span>

    <span class="cm">/*</span>
<span class="cm">     * Any external dependencies shouldn&#39;t be included; they are included in the file</span>
<span class="cm">     * located in the component to which they belong.</span>
<span class="cm">     * In this configuration only the raintime dependencies are excluded, but any external</span>
<span class="cm">     * module should be added here.</span>
<span class="cm">     */</span>
    <span class="nx">exclude</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;raintime&quot;</span><span class="p">],</span>

    <span class="nx">out</span><span class="o">:</span> <span class="s1">&#39;/path/to/rain/components/example/client/js/index.min.js&#39;</span><span class="p">,</span>

    <span class="cm">/*</span>
<span class="cm">     * An empty module is added at the end of the file since the require for the minified</span>
<span class="cm">     * file will look like: require([&#39;example/3.0/js/index.min]&#39;, function () {});</span>
<span class="cm">     */</span>
    <span class="nx">wrap</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">end</span><span class="o">:</span> <span class="s1">&#39;define(&#39;</span><span class="nx">example</span><span class="o">/</span><span class="mf">3.0</span><span class="o">/</span><span class="nx">js</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">min</span><span class="s1">&#39;, [], function () {});&#39;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     * This function is called when the contents of a module are read. It is also called for</span>
<span class="cm">     * excluded modules.</span>
<span class="cm">     * It adds an empty define for modules that are loaded in the global scope like jquery.</span>
<span class="cm">     * RequireJS Optimizer does this automatically, but this define isn&#39;t included in the</span>
<span class="cm">     * contents passed to the onBuildWrite method where module names are replaced with the</span>
<span class="cm">     * correct names for the RAIN context.</span>
<span class="cm">     */</span>
    <span class="nx">onBuildRead</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// global modules</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">contents</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;define(&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">contents</span> <span class="o">+=</span> <span class="s1">&#39;\n\n&#39;</span><span class="p">;</span>
            <span class="nx">contents</span> <span class="o">+=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;define(&quot;%s&quot;, function(){});&#39;</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">);</span>
            <span class="nx">contents</span> <span class="o">+=</span> <span class="s1">&#39;\n\n&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">contents</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     * On build write is called before the contents of a module are added to the minified file.</span>
<span class="cm">     * It replaces the module names with the correct ones, RequireJS Optimizer has no knowledge</span>
<span class="cm">     * about RAIN&#39;s components and routes. For example js/notes becomes example/3.0/js/notes.</span>
<span class="cm">     */</span>
    <span class="nx">onBuildWrite</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">util</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;example/3.0/%s&#39;</span><span class="p">,</span> <span class="nx">moduleName</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>After this, the RequireJS Optimizer is called with these options to perform the actual
minification:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">requirejs</span><span class="p">.</span><span class="nx">optimize</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// minification finished</span>
<span class="p">});</span>
</pre></div>
</div>
<p>An exception from the process described above is the <tt class="docutils literal"><span class="pre">core</span></tt> component. The configuration for
the <tt class="docutils literal"><span class="pre">core</span></tt> component is written manually and it should look like this:</p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">baseUrl</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">coreComponentPath</span><span class="p">,</span> <span class="s1">&#39;client/js&#39;</span><span class="p">),</span>
    <span class="nx">optimize</span><span class="o">:</span> <span class="s2">&quot;uglify2&quot;</span><span class="p">,</span>
    <span class="nx">uglify2</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">mangle</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">},</span>

    <span class="s2">&quot;packages&quot;</span><span class="o">:</span> <span class="p">[{</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;raintime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;raintime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;location&quot;</span><span class="o">:</span> <span class="s2">&quot;.&quot;</span>
    <span class="p">}],</span>

    <span class="cm">/*</span>
<span class="cm">     * These modules have all the other modules in the core component as dependencies.</span>
<span class="cm">     * When adding modules to the core component you need to make sure that all the modules</span>
<span class="cm">     * from the core component are still included in the minified file. Just putting all</span>
<span class="cm">     * the files in the include list will not help since the modules should appear in a</span>
<span class="cm">     * specific order to guarantee that module dependencies will be resolve correctly.</span>
<span class="cm">     */</span>
    <span class="nx">include</span><span class="o">:</span> <span class="p">[</span>
        <span class="s1">&#39;raintime/dependencies&#39;</span><span class="p">,</span>
        <span class="s1">&#39;raintime/client_rendering&#39;</span><span class="p">,</span>
        <span class="s1">&#39;raintime/dialog&#39;</span><span class="p">,</span>
        <span class="s1">&#39;raintime/translation&#39;</span>
    <span class="p">],</span>
    <span class="nx">out</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">coreComponentPath</span><span class="p">,</span> <span class="s1">&#39;client/js/index.min.js&#39;</span><span class="p">),</span>

    <span class="nx">wrap</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">end</span><span class="o">:</span> <span class="s2">&quot;define(&#39;raintime/index.min&#39;, [], function () {});&quot;</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<dl class="docutils">
<dt>The current minification prototype requires a few improvements which are listed below:</dt>
<dd><ul class="first last simple">
<li>the files that need to be included for the <tt class="docutils literal"><span class="pre">core</span></tt> component should be found automatically.
An approach might be to use the RequireJS optimizer to trace the dependencies for each module
an than adding all the files to the include list in the correct order. This might not be an
issue in our case since the module that is required when requesting the file is the empty
<tt class="docutils literal"><span class="pre">raintime/index.min</span></tt> module which has no dependencies. When any other module is requested
all the other modules will already be loaded and no new request will be performed.</li>
<li>a proper strategy that uses a JavaScript parser and a code generator (Esprima + escodegen)
should be used to analyze and rewrite the content of the module. The simple string replace
that is used now will fail in some cases, e.g.: a module contains the module name in its content
(not only in the define call as expected).</li>
<li>name mangling should be enabled in order to obtain smaller file sizes. The current issue is that
<tt class="docutils literal"><span class="pre">t</span></tt>, <tt class="docutils literal"><span class="pre">nt</span></tt> and <tt class="docutils literal"><span class="pre">logger</span></tt> names should be preserved and no way of excluding only these names
from mangling was found.
One approach is to change the implementation for the way <tt class="docutils literal"><span class="pre">t</span></tt>, <tt class="docutils literal"><span class="pre">nt</span></tt>  and <tt class="docutils literal"><span class="pre">logger</span></tt>
dependencies are obtained to something like <tt class="docutils literal"><span class="pre">define(['t',</span> <span class="pre">'nt'],</span> <span class="pre">function</span> <span class="pre">(t,</span> <span class="pre">nt)</span> <span class="pre">{});</span></tt>
In this case the string literals aren&#8217;t touched by the minification and it is safe
to change the name of <tt class="docutils literal"><span class="pre">t</span></tt> and <tt class="docutils literal"><span class="pre">nt</span></tt> while minifying. The <tt class="docutils literal"><span class="pre">t</span></tt> and <tt class="docutils literal"><span class="pre">nt</span></tt> names should
still be used in unminified code in order to guarantee that the generate po files sdk command
is working correctly.</li>
<li>currently external dependencies aren&#8217;t working except for raintime dependencies. When a
dependency like <tt class="docutils literal"><span class="pre">external/1.0/js/module</span></tt> is found the RequireJS optimizer will fail to
locate the dependency with the current configuration. This should work if all the other
components are added as packages and excluded, but we should establish what module names are
supported.</li>
<li>currently only dependencies of the form <tt class="docutils literal"><span class="pre">js/module</span></tt> and raintime dependencies are supported.
We should come up with a list of supported module paths and see what needs to be done to
make them work.</li>
</ul>
</dd>
</dl>
<p>Some changes need to be implemented in RAIN to use the minified files:</p>
<blockquote>
<div><ul class="simple">
<li>a flag indicating if minification is enabled should be added</li>
<li>the dependencies module should be modified to support multiple modules per file</li>
<li>raintime should be modified to require the <tt class="docutils literal"><span class="pre">index.min</span></tt> module associated with the component
before requiring the client side controller when minification is used.</li>
<li>the bootstrap should be modified to require the minified raintime.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="css-minification">
<h2>CSS Minification<a class="headerlink" href="#css-minification" title="Permalink to this headline">¶</a></h2>
<p>The tool used for CSS minification is less. It supports CSS minification using the YUI compressor.
All the css files (*.css) for a component are rendered using less and placed in the same file.
The rules should also be counted when adding CSS to the minified file to avoid the situation where
more than 4095 rules are added in the same file. If this is the case, a JSON file should be created
specifying which files were added to which minified file.</p>
<p>Some changes needs to be implemented in RAIN to use the minified files:</p>
<blockquote>
<div><ul class="simple">
<li>a flag indicating if minification is enabled should be added</li>
<li>the css helper should be modified to replace the requested css file path with the minified file
when minification is enabled. It should also ensure that the same path is added only once in the
css list</li>
<li>there is an issue when precompiling less at server startup that when multiple URLs are on the
same line, only the first URL is rewritten</li>
<li>media queries aren&#8217;t working properly in the current prototype because all the CSS files are
placed in the same file and no mather which file will be matched by the media query selector
the same css will be placed in the page.</li>
</ul>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">JavaScript and CSS Minification</a><ul>
<li><a class="reference internal" href="#javascript-minification">JavaScript Minification</a></li>
<li><a class="reference internal" href="#css-minification">CSS Minification</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="distributed_websockets.html"
                        title="previous chapter">Distributed Websockets</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="nginx_static_routes.html"
                        title="next chapter">NginX static routes server</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="nginx_static_routes.html" title="NginX static routes server"
             >next</a> |</li>
        <li class="right" >
          <a href="distributed_websockets.html" title="Distributed Websockets"
             >previous</a> |</li>
        <li><a href="../index.html">Rain v0.33.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>